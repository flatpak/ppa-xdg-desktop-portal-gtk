From: Matthias Clasen <mclasen@redhat.com>
Date: Tue, 6 Jun 2017 12:25:33 -0400
Subject: App picker: Add an empty state

This is following the evolving app picker mockups.

Origin: upstream, 0.8, commit:56c3049c5d60a643db55e59e14df2c185f18e1ff
---
 src/appchooserdialog.c   | 91 +++++++++++++++++++++++++++++++++++++-----------
 src/appchooserdialog.css |  5 +++
 src/appchooserdialog.ui  | 75 +++++++++++++++++++++++++++++++++++++++
 3 files changed, 150 insertions(+), 21 deletions(-)

diff --git a/src/appchooserdialog.c b/src/appchooserdialog.c
index bb28101..855d9aa 100644
--- a/src/appchooserdialog.c
+++ b/src/appchooserdialog.c
@@ -45,6 +45,9 @@ struct _AppChooserDialog {
   GtkWidget *heading;
   GtkWidget *search_bar;
   GtkWidget *search_entry;
+  GtkWidget *stack;
+  GtkWidget *separator;
+  GtkWidget *empty_label;
 
   char *content_type;
   char *search_text;
@@ -135,9 +138,7 @@ show_error_dialog (const gchar *primary,
 }
 
 static void
-link_activated (GtkWidget *label,
-                const char *uri,
-                AppChooserDialog *dialog)
+launch_software (AppChooserDialog *dialog)
 {
   g_autofree char *option = NULL;
   g_autoptr(GSubprocess) process = NULL;
@@ -154,6 +155,21 @@ link_activated (GtkWidget *label,
 }
 
 static void
+link_activated (GtkWidget *label,
+                const char *uri,
+                AppChooserDialog *dialog)
+{
+  launch_software (dialog);
+}
+
+static void
+find_in_software (GtkWidget *button,
+                  AppChooserDialog *dialog)
+{
+  launch_software (dialog);
+}
+
+static void
 populate_full_list (AppChooserDialog *dialog)
 {
   GList *apps, *l;
@@ -213,6 +229,15 @@ more_clicked (GtkButton *button,
   show_full_list (dialog);
 }
 
+static void
+more2_clicked (GtkButton *button,
+               AppChooserDialog *dialog)
+{
+  gtk_stack_set_visible_child_name (GTK_STACK (dialog->stack), "list");
+  gtk_widget_hide (dialog->separator);
+  show_full_list (dialog);
+}
+
 static gboolean
 filter_func (GtkFlowBoxChild *child,
              gpointer data)
@@ -303,12 +328,17 @@ app_chooser_dialog_class_init (AppChooserDialogClass *class)
   gtk_widget_class_bind_template_child (widget_class, AppChooserDialog, heading);
   gtk_widget_class_bind_template_child (widget_class, AppChooserDialog, search_bar);
   gtk_widget_class_bind_template_child (widget_class, AppChooserDialog, search_entry);
+  gtk_widget_class_bind_template_child (widget_class, AppChooserDialog, stack);
+  gtk_widget_class_bind_template_child (widget_class, AppChooserDialog, separator);
+  gtk_widget_class_bind_template_child (widget_class, AppChooserDialog, empty_label);
   gtk_widget_class_bind_template_callback (widget_class, row_activated);
   gtk_widget_class_bind_template_callback (widget_class, cancel_clicked);
   gtk_widget_class_bind_template_callback (widget_class, link_activated);
   gtk_widget_class_bind_template_callback (widget_class, more_clicked);
+  gtk_widget_class_bind_template_callback (widget_class, more2_clicked);
   gtk_widget_class_bind_template_callback (widget_class, search_changed);
   gtk_widget_class_bind_template_callback (widget_class, key_press_event_cb);
+  gtk_widget_class_bind_template_callback (widget_class, find_in_software);
 }
 
 AppChooserDialog *
@@ -340,7 +370,7 @@ app_chooser_dialog_new (const char **choices,
     {
       g_autofree char *heading = NULL;
 
-      heading = g_strdup_printf (_("Select an application to open '%s'. More applications are available in <a href='software'>Software.</a>"), filename);
+      heading = g_strdup_printf (_("Select an application to open “%s”. More applications are available in <a href='software'>Software.</a>"), filename);
       gtk_label_set_label (GTK_LABEL (dialog->heading), heading);
     }
   else
@@ -351,25 +381,44 @@ app_chooser_dialog_new (const char **choices,
   default_row = NULL;
 
   n_choices = g_strv_length ((char **)choices);
-  for (i = 0; i < n_choices; i++)
+  if (n_choices == 0)
     {
-      g_autofree char *desktop_id = g_strconcat (choices[i], ".desktop", NULL);
-      g_autoptr(GAppInfo) info = G_APP_INFO (g_desktop_app_info_new (desktop_id));
-      GtkWidget *row;
-
-      row = GTK_WIDGET (app_chooser_row_new (info));
-      gtk_widget_set_visible (row, TRUE);
-      gtk_flow_box_insert (GTK_FLOW_BOX (dialog->list), row, -1);
-
-      if (g_strcmp0 (choices[i], default_id) == 0)
-        default_row = row;
+      gtk_stack_set_visible_child_name (GTK_STACK (dialog->stack), "empty");
+      if (filename)
+        {
+          g_autofree char *label = NULL;
+
+          label = g_strdup_printf (_("Unable to find an application that is able to open “%s”."), filename);
+          gtk_label_set_label (GTK_LABEL (dialog->empty_label), label);
+        }
+      else
+        {
+          gtk_label_set_label (GTK_LABEL (dialog->empty_label), _("Unable to find a suitable application."));
+        }
+    }
+  else
+    {
+      gtk_stack_set_visible_child_name (GTK_STACK (dialog->stack), "list");
+      for (i = 0; i < n_choices; i++)
+        {
+          g_autofree char *desktop_id = g_strconcat (choices[i], ".desktop", NULL);
+          g_autoptr(GAppInfo) info = G_APP_INFO (g_desktop_app_info_new (desktop_id));
+          GtkWidget *row;
+
+          row = GTK_WIDGET (app_chooser_row_new (info));
+          gtk_widget_set_visible (row, TRUE);
+          gtk_flow_box_insert (GTK_FLOW_BOX (dialog->list), row, -1);
+
+          if (g_strcmp0 (choices[i], default_id) == 0)
+            default_row = row;
+       }
+
+     if (n_choices < 4)
+       gtk_widget_set_halign (dialog->list, GTK_ALIGN_START);
+
+     if (default_row)
+       gtk_widget_grab_focus (default_row);
     }
-
-  if (n_choices < 4)
-    gtk_widget_set_halign (dialog->list, GTK_ALIGN_START);
-
-  if (default_row)
-    gtk_widget_grab_focus (default_row);
 
   gtk_flow_box_set_filter_func (GTK_FLOW_BOX (dialog->full_list), filter_func, dialog, NULL);
 
diff --git a/src/appchooserdialog.css b/src/appchooserdialog.css
index f98ce19..d727693 100644
--- a/src/appchooserdialog.css
+++ b/src/appchooserdialog.css
@@ -7,3 +7,8 @@ label.heading {
 button.more {
   margin: 20px;
 }
+
+label.bold-heading {
+  font-size: 20pt;
+  font-weight: bold;
+}
diff --git a/src/appchooserdialog.ui b/src/appchooserdialog.ui
index 3e390ba..86d82b7 100644
--- a/src/appchooserdialog.ui
+++ b/src/appchooserdialog.ui
@@ -54,6 +54,9 @@
           </object>
         </child>
         <child>
+          <object class="GtkStack" id="stack">
+            <property name="visible">1</property>
+        <child>
           <object class="GtkScrolledWindow" id="scrolled_window">
             <property name="visible">1</property>
             <property name="expand">1</property>
@@ -141,8 +144,80 @@
               </object>
             </child>
           </object>
+          <packing>
+            <property name="name">list</property>
+          </packing>
+        </child>
+        <child>
+          <object class="GtkBox">
+            <property name="visible">1</property>
+            <property name="orientation">vertical</property>
+            <style>
+              <class name="view"/>
+            </style>
+            <child type="center">
+              <object class="GtkBox">
+                <property name="visible">1</property>
+                <property name="orientation">vertical</property>
+                <property name="spacing">10</property>
+                <child>
+                  <object class="GtkLabel">
+                    <property name="visible">1</property>
+                    <property name="label" translatable="yes">No Applications Found</property>
+                    <style>
+                      <class name="bold-heading"/>
+                    </style>
+                  </object>
+                </child>
+                <child>
+                  <object class="GtkLabel" id="empty_label">
+                    <property name="visible">1</property>
+                    <property name="label">Too bad!</property>
+                  </object>
+                </child>
+                <child>
+                  <object class="GtkButton" id="find_software_button">
+                    <property name="visible">1</property>
+                    <property name="halign">center</property>
+                    <property name="label" translatable="yes">Find Compatible Applications in Software</property>
+                    <signal name="clicked" handler="find_in_software"/>
+                    <style>
+                      <class name="suggested-action"/>
+                    </style>
+                  </object>
+                </child>
+              </object>
+            </child>
+            <child>
+              <object class="GtkButton" id="more2_button">
+                <property name="visible">1</property>
+                <property name="halign">center</property>
+                <property name="valign">end</property>
+                <signal name="clicked" handler="more2_clicked"/>
+                <style>
+                  <class name="circular"/>
+                  <class name="more"/>
+                </style>
+                <child>
+                  <object class="GtkImage">
+                    <property name="visible">1</property>
+                    <property name="icon-name">view-more-symbolic</property>
+                    <property name="icon-size">1</property>
+                  </object>
+                </child>
+              </object>
+              <packing>
+                <property name="pack-type">end</property>
+              </packing>
+            </child>
+          </object>
+          <packing>
+            <property name="name">empty</property>
+          </packing>
         </child>
       </object>
+      </child>
+    </object>
     </child>
   </template>
 </interface>
